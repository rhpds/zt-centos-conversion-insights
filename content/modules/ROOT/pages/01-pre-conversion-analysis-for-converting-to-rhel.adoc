In this first part of the lab, we’ll perform a pre-conversion analysis
with Insights. In subsequent steps of this lab, we’ll perform the
convert2rhel operation.

== What is Convert2RHEL?

Convert2RHEL is a command line utility that allows for self-service
migration between RHEL-like distributions to officially supported Red
Hat Enterprise Linux instances.

The convert2rhel tool handles subscribing the target system to your Red
Hat customer account while maintaining customizations, configurations,
and workloads.

Convert2RHEL is also a supported operation which means if you run into
issues with the conversion process, you can open a ticket with Red Hat
Support.

== What is the Insights pre-conversion analysis?

To assess whether your CentOS Linux systems can be converted to RHEL,
run the Pre-conversion analysis for converting to RHEL task. The
preconversion analysis generates a report that summarizes potential
problems and suggests recommended solutions. The report also helps you
decide whether it is possible or advisable to proceed with the
conversion to RHEL.

Please see the official Red Hat documentation on pre-conversion analysis
in Insights,
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/converting_from_an_rpm-based_linux_distribution_to_rhel/index#proc_preparing-for-a-rhel-conversion-using-insights_converting-using-insights[here].

== Change centos repo urls

Now that centos has reached its end of life, updates are only available
at `+vault.centos.org+`. We’ll have to change all the repository URLs in
`+/etc/yum.repos.d/+`. Please run the following 3 commands.

[source,bash,run]
----
sed -i s/mirror.centos.org/vault.centos.org/g /etc/yum.repos.d/*.repo
----

[source,bash,run]
----
sed -i s/^#.*baseurl=http/baseurl=http/g /etc/yum.repos.d/*.repo
----

[source,bash,run]
----
sed -i s/^mirrorlist=http/#mirrorlist=http/g /etc/yum.repos.d/*.repo
----

== Install the client tools

Copy and paste the command below into the centos terminal. This command
will download the Red Hat GPG key.

[source,bash,run]
----
curl -o /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release https://security.access.redhat.com/data/fd431d51.txt
----

Next, configure your host repositories to download Red Hat client tools.
These tools are required to connect to console.redhat.com so that we can
run the pre-conversion analysis.

[source,bash,run]
----
curl -o /etc/yum.repos.d/client-tools.repo https://cdn-public.redhat.com/content/public/repofiles/client-tools-for-rhel-7-server.repo
----

Install the required client tools packages. These include `+rhc+`,
`+rhc-worker-script+`, and `+insights-client+`.

[source,bash,run]
----
yum -y install subscription-manager subscription-manager-rhsm-certificates rhc rhc-worker-script insights-client
----

== Run the client tools

Now we’ll run a couple commands that will enable use to run the
pre-conversion analysis from Red Hat Insights. The command below
registers the host to Red Hat Subscription Manager with the activation
key `+convert2rhel+`. Next the command connects enables Remote Host
Configuration with `+rhc-connect+`. The `+insights-client --register+`
registers the system with Insights.

[source,bash,run]
----
rhc connect --activation-key convert2rhel --organization 12451665
----

Here’s what the output should look like.

.output
image::../assets/registeredoutput.png[output]

For more information on these commands see the following documentation:
- https://access.redhat.com/solutions/253273[subscription-manager] -
https://access.redhat.com/articles/rhc[rhc] -
https://access.redhat.com/documentation/en-us/red_hat_insights/2023/html/client_configuration_guide_for_red_hat_insights/index[insights-client]

== Log into Red Hat Insights

Now we’ll log into Red Hat Insights.

.insights
image::../assets/insightsvirtualbrowser.png[insights]

[arabic]
. Click on the tab labelled `+Red Hat Insights+`
. Enter the following Red Hat login.

....
rhel-0ab2
....

[arabic, start=3]
. Enter the following password.

....
Redhat1!
....

== Run the pre-conversion task

Navigate to RHEL tasks.

[arabic]
. Click on the search icon.

image:../assets/searchicon.png[../assets/searchicon]

In the search bar, enter the following.

....
rhel tasks
....

[arabic, start=2]
. Click on `+Tasks | RHEL+`

image:../assets/tasksnew.png[../assets/tasksnew]

In the `+Tasks+` menu, click `+Select systems+` in the
`+Pre-conversion analysis for converting to RHEL+` section.

.conversion tasks
image::../assets/runtask.png[conversion tasks]

Copy the string below, which contains the CentOS host name. This value
varies between lab instances and is not necessarily what is shown below
in the screenshot.

....
Pre-conversion task for [[ Instruqt-Var key="vmid" hostname="host" ]]
....

Paste this string into the `+Task name+` field.

.task name
image::../assets/taskname.png[task name]

Next, select your host [[ Instruqt-Var key="`vmid`" hostname="`host`"
]].

*If the host does not appear you may have to wait a minute or two and
retry the `+Pre-conversion analysis+` task.*

.centoshost select
image::../assets/centoshostselect.png[centoshost select]

Then click `+Next+`.

image:../assets/nexttask.png[../assets/nexttask]

Finally, you will be presented with a selection of options to ignore
specific pre-conversion check results. We will ignore these for this
lab.

If your host is entitled to an ELS subscription, you can ignore the
`+Do not use the ELS Subscription+` option.

Click on `+Run task+`.

.execute task
image::../assets/executetask.png[execute task]

Once you click on `+Run task+`, a message is sent to the `+rhc+` service
running on the centos host telling it there is a job waiting for it to
download and execute. The centos host downloads the job from Red Hat
Insights where it installs `+convert2rhel+` and runs the
`+Pre-conversion analysis+` task. Once that task is complete, a message
is sent back to Insights with the status and the results of the task.

== Checking the status of the task

There are 2 ways to check on the status of the task. The first is to
read the `+convert2rhel+` logs on the `+centos+` host. The second is to
view the status of the task in Insights.

To view the `+convert2rhel+` logs, enter the following in the cli of the
`+centos+` host.

[source,bash,run]
----
tail -f /var/log/convert2rhel/convert2rhel.log
----

.tail logs
image::../assets/viewlogs.png[tail logs]

____
[!WARNING] The `+tail -f /var/log/convert2rhel/convert2rhel.log+` may
result in the following error below because there may be a delay between
the previous operation to run the pre-conversion analysis and your
centos host running the task.

....
tail: cannot open ‘/var/log/convert2rhel/convert2rhel.log’ for reading: No such file or directory
tail: no files remaining
....
____

To view the status of the task in Insights, click on the `+Activity+`
tab.

.activity tab
image::../assets/activitytab.png[activity tab]

Click on the task you created. The name of the task is

....
Pre-conversion task for [[ Instruqt-Var key="vmid" hostname="host" ]]
....

.task
image::../assets/clicktask.png[task]

At this point the task is still running and may take about 10 minutes to
complete.

.task status
image::../assets/taskstatus.png[task status]

Periodically click on the refresh button of the virtual browser to see
if the task has finished.

.refresh
image::../assets/refreshstatus.png[refresh]

When the task has finished, you can view the results by clicking on the
successfully completed task.

.completed task
image::../assets/completedtask.png[completed task]

Expand the task to view the inhibitors.

.view inhibitors
image::../assets/expandtoviewinhibitors.png[view inhibitors]

The inhibitors may vary. In this case the kernel is too old.

.inhibitors
image::../assets/invalidkernel.png[inhibitors]

Please proceed to the next step.
